{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "test_rpc_button_step_by_step",
    "name" : "test rpc button step by step",
    "deprecated" : false,
    "image" : "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACgCAAAAABslHx1AAAAAmJLR0QA/4ePzL8AAAN8SURBVHja7dvbSxRRHAfw/X9+bhcvrJZSmllhZFSCWBDaY4FUhBRZCQXR7akLyoJYlqxU0g0tukF0oYQM3bxsYVRgbuuyu7k7szNn9vSb2Wx9qB56ac72/T7MHGYZmA/nMjvDbzzSTkbpOASPw7CUjkPx2AwhTNNQNKYphE1hiCXMtK5pWkrB8GXraZMl0sMOQ9dEdqApmIzQdIMlDDH1lLIMh5LSTYZYIp1MS6XDAGF5uEPiltoQK85dwhAtKhVPVLMhRj5ADAcyqzpkNgtJqQ9JAQIIIIAAAggggAACCCB/8wog8btfAjd+f9Y3t0GmW5bS8rO/fvavaXB2jWVlZbVHwjLC+7L1x2P8rN1ZQcWtX90EyWws7r7bSuf+BKnz+f1t3norTPV+/0HvNiFP0+5b54sahYsgn+mQrdksZfL6hYcZGe2betoxyG/LtP7OiXlIJW/a6F2Y9nPjKI3MLtrBjbM05CJIsqT6tdOI1BbWFuyRQVpbupw7yGygqqLCBZCTNJqFdNGTAQpwY2bwo5vmyL1iqr+uS3l4yaTsoaEg7bT0VXWyn/xyquQHpDz4JuCrFWHaG48OrSuJXqLHLly1Yl01VDkuq6r7+i5Qd5ABsqlctlMiN0eI0/BZhu09rXggu10J4TVoYMlWWeKr51x2IM3lcp83k4NUfAqVbrQYsn3w/lvuvTt0lQ9Hn027CNJLt3m7YaXctIaXYCHnIWfog5Src3Okg/pldo7Ys8O7S9qHXrgIEllWee35uYJ9MkAHXgVq3s9Dxguan56iHCRZUa3/hPDAa3/U7dtiuGloTTZ7aXFrnO9xPio8Zs5D5JViaqpbsGpdpK4cxDxRRItbpl02R1Jfsje2zIy+8LCI/ekkc0a4b7Lj3y8ggAACCCCAAAIIIIAA8v9C8qaoRosqXngmsmVOXHgWVxsSyxaemXosJFR2mBMxpxRQpOPB0YihKsOIjAbjdnEml8vOhUaGX97s7VEwvTdfDo+E5kyn7pe7JDQWVDZjIbtDMk5JuZGcSyQScQXDlz2XNJyS8vwp8s+bzy6kzJsPYfIigAACCCCAAAIIIIAAAggggAACCCCAAAIIIIAAAggggAACCCCAAAIIIIAAAggggAACCCCAAAIIIIAAAggggAACCCCAAAIIIIAAAggggAACCCCAAAIIIIAAAggg/yTfATinNXQTM7TQAAAAAElFTkSuQmCC",
    "description" : "Allows to send RPC command when the user presses the button.",
    "descriptor" : {
      "type" : "rpc",
      "sizeX" : 4,
      "sizeY" : 2,
      "resources" : [ ],
      "templateHtml" : "<div class=\"tb-rpc-button\" fxLayout=\"column\">\n    <div fxFlex=\"20\" class=\"title-container\" fxLayout=\"row\"\n        fxLayoutAlign=\"center center\" [fxShow]=\"showTitle\">\n        <span class=\"button-title\">{{title}}</span>\n    </div>\n    <div fxFlex=\"{{showTitle ? 80 : 100}}\" [ngStyle]=\"{paddingTop: showTitle ? '5px': '10px'}\"\n        class=\"button-container\" fxLayout=\"column\" fxLayoutAlign=\"center center\">\n        <div>\n            <button mat-button (click)=\"clickable ? sendCommand() : ''\"\n                    [class.mat-mdc-raised-button]=\"styleButton?.isRaised\"\n                    [color]=\"styleButton?.isPrimary ? 'primary' : ''\"\n                    [ngStyle]=\"customStyle\">\n                {{buttonLable}}\n            </button>\n        </div>\n    </div>\n    <div class=\"error-container\" [ngStyle]=\"{'background': error?.length ? 'rgba(255,255,255,0.25)' : 'none'}\"\n         fxLayout=\"row\" fxLayoutAlign=\"center center\">\n        <span class=\"button-error\">{{ error }}</span>\n    </div>\n</div>",
      "templateCss" : ".tb-rpc-button {\n    width: 100%;\n    height: 100%;\n}\n\n.tb-rpc-button .title-container {\n    font-weight: 500;\n    white-space: nowrap;\n    margin: 10px 0;\n}\n\n.tb-rpc-button .button-container div{\n    min-width: 80%\n}\n\n.tb-rpc-button .button-container .mat-mdc-button{\n    width: 100%;\n    margin: 0;\n}\n\n.tb-rpc-button .error-container {\n    position: absolute;\n    top: 2%;\n    right: 0;\n    left: 0;\n    z-index: 4;\n    height: 14px;\n}\n\n.tb-rpc-button .error-container .button-error {\n    color: #ff3315;\n    white-space: nowrap;\n}",
      "controllerScript" : "var requestPersistent = false;\nvar persistentPollingInterval = 5000;\nvar rpc_click_function = false;\n var mission_array = [];\nself.onInit = function() {\n    if (self.ctx.settings.requestPersistent) {\n        requestPersistent = self.ctx.settings.requestPersistent;\n    }\n    if (self.ctx.settings.persistentPollingInterval) {\n        persistentPollingInterval = self.ctx.settings.persistentPollingInterval;\n    }\n    self.ctx.ngZone.run(function() {\n       init();\n       getbroadcastService();\n       self.ctx.detectChanges();\n    });\n};\nfunction getbroadcastService(){\n    console.log(\"getbroadcastService\")\n    self.ctx.broadcastService = self.ctx.$scope.$injector.get(self.ctx.servicesMap.get('broadcastService'));\n    self.ctx.broadcastService.on(self.ctx.defaultSubscription.targetDeviceName, (evt, data) => {\n        console.log(\"mission \" + JSON.parse(self.ctx.settings.methodParams).mission_name + \" broadcastService\")\n        // 整理mission array\n        let has_mission_list = false;\n        $.each( data[0] , (index,value) =>{\n            if(value.dataKey.name == 'mission_list'){\n                has_mission_list = true;\n                mission_array = value.data[0][1].split(',');\n            } \n        });\n        // 比對button function對應的mission名稱\n        let button_state, has_telemetry_key = false;\n        $.each( data[0] , (index,value) =>{\n            if(value.dataKey.name == JSON.parse(self.ctx.settings.methodParams).mission_name){\n                has_telemetry_key = true;\n                button_state = value.data[0][1];\n            }\n        });\n        if(!has_mission_list){\n            console.log(\"please insert MISSION LIST broadcast service and telemetry key\")\n        }else if(!has_telemetry_key){\n            console.log(\"please insert correct MISSION NAME in RPC method params and telemetry key\")\n        }else{\n            button_style_change(button_state,mission_array[0]);\n            console.log({\n                broadcast_device: self.ctx.defaultSubscription.targetDeviceName,\n                broadcast_data: data[0],\n                runtime_mission: mission_array[0],\n                mission_array: mission_array,\n                button_mission: JSON.parse(self.ctx.settings.methodParams).mission_name,\n                button_state: button_state,\n            })\n            self.ctx.detectChanges();\n        }\n    });\n}\n\nfunction button_style_change(arg , first_mission_name){\n    if(arg == 1){\n        if(!rpc_click_function){\n            self.ctx.$scope.clickable = true;\n            self.ctx.$scope.customStyle = {\n                'background-color': self.ctx.$scope.styleButton.bgColor,\n                'color': self.ctx.$scope.styleButton.textColor\n            };\n            self.ctx.$scope.buttonLable = self.ctx.settings.buttonText;\n        }\n    }else if(arg == 0){\n        self.ctx.$scope.clickable = false;\n        rpc_click_function = false;\n        //成功後變成灰底白字\n        self.ctx.$scope.customStyle = {\n            'background-color': \"#808080\",\n            'color': \"#FFF\",\n            'opacity': '1',\n            'cursor': 'not-allowed'\n        };\n        self.ctx.$scope.buttonLable = (first_mission_name == JSON.parse(self.ctx.settings.methodParams).mission_name) ? 'AMR Comming' : self.ctx.settings.buttonText;\n    }else{\n        self.ctx.$scope.clickable = false;\n        self.ctx.$scope.customStyle = {\n            'background-color': '#F44336',\n            'color': '#FFF',\n            'opacity': '1',\n            'cursor': 'not-allowed'\n        };\n        self.ctx.$scope.buttonLable = 'AMR abort';\n    }\n    self.ctx.detectChanges();\n    \n}\nfunction init() {\n    let rpcEnabled = self.ctx.defaultSubscription.rpcEnabled;\n    self.ctx.$scope.buttonLable = self.ctx.settings.buttonText;\n    self.ctx.$scope.showTitle = self.ctx.settings.title &&\n        self.ctx.settings.title.length ? true : false;\n    self.ctx.$scope.title = self.ctx.settings.title;\n    self.ctx.$scope.styleButton = self.ctx.settings.styleButton;\n    self.ctx.$scope.clickable = false;\n\n    if (self.ctx.settings.styleButton.isPrimary ===\n        false) {\n        self.ctx.$scope.clickable = false;\n        //成功後變成灰底白字\n        self.ctx.$scope.customStyle = {\n            'background-color': \"#808080\",\n            'color': \"#FFF\",\n            'cursor': 'not-allowed',\n            'opacity': '1',\n        };\n    }\n\n    if (!rpcEnabled) {\n        self.ctx.$scope.error =\n            'Target device is not set!';\n    }\n\n    self.ctx.$scope.sendCommand = function() {\n        console.log(\"sendCommand function\")\n        //Click sendCommand function style\n        self.ctx.$scope.clickable = false;\n        rpc_click_function = true;\n        self.ctx.$scope.customStyle = {\n            'background-color': self.ctx.$scope.styleButton.bgColor,\n            'color': self.ctx.$scope.styleButton.textColor,\n            'opacity': '0.6',\n            'cursor': 'progress'\n        };\n        self.ctx.$scope.buttonLable = \"Waiting for response\";\n        self.ctx.detectChanges();\n        \n        var rpcMethod = self.ctx.settings.methodName;\n        var rpcParams = self.ctx.settings.methodParams;\n        if (rpcParams.length) {\n            try {\n                rpcParams = JSON.parse(rpcParams);\n            } catch (e) {}\n        }\n        var timeout = self.ctx.settings.requestTimeout;\n        var oneWayElseTwoWay = self.ctx.settings.oneWayElseTwoWay ?\n            true : false;\n\n        var commandPromise;\n        if (oneWayElseTwoWay) {\n            commandPromise = self.ctx.controlApi.sendOneWayCommand(\n                rpcMethod, rpcParams, timeout, requestPersistent, persistentPollingInterval);\n        } else {\n            commandPromise = self.ctx.controlApi.sendTwoWayCommand(\n                rpcMethod, rpcParams, timeout, requestPersistent, persistentPollingInterval);\n        }\n        commandPromise.subscribe(\n            function success(arg) {\n                console.log(arg)\n                self.ctx.$scope.error = \"\";\n                //Click sendCommand function style\n                self.ctx.$scope.clickable = false;\n                self.ctx.$scope.customStyle = {\n                    'background-color': \"#808080\",\n                    'color': \"#FFF\",\n                    'cursor': 'not-allowed',\n                    'opacity': '1',\n                };\n                self.ctx.$scope.buttonLable = ( JSON.parse(arg).result == true ) ? 'Mission in Queue' : 'Mission False';\n                self.ctx.detectChanges();\n            },\n            function fail(rejection) {\n                if (self.ctx.settings.showError) {\n                    self.ctx.$scope.error =\n                        rejection.status + \": \" +\n                        rejection.statusText;\n                    self.ctx.detectChanges();\n                }\n            }\n        );\n    };\n}\nself.onDestroy = function() {\n    self.ctx.controlApi.completedCommand();\n}\n",
      "settingsSchema" : "",
      "dataKeySettingsSchema" : "{}\n",
      "settingsDirective" : "tb-send-rpc-widget-settings",
      "defaultConfig" : "{\"showTitle\":false,\"backgroundColor\":\"#e6e7e8\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"requestTimeout\":5000,\"oneWayElseTwoWay\":true,\"buttonText\":\"Send RPC\",\"styleButton\":{\"isRaised\":true,\"isPrimary\":false},\"methodName\":\"rpcCommand\",\"methodParams\":\"{}\"},\"title\":\"test rpc button step by step\",\"dropShadow\":true,\"enableFullscreen\":false,\"widgetStyle\":{},\"titleStyle\":{\"fontSize\":\"16px\",\"fontWeight\":400},\"useDashboardTimewindow\":true,\"showLegend\":false,\"actions\":{},\"targetDeviceAliases\":[]}"
    },
    "externalId" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "916512f0-ba7e-11ee-8277-4972a19a05da"
    }
  },
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}